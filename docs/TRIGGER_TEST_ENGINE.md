# Trigger íŒ¨í„´ ë§¤ì¹­ í…ŒìŠ¤íŠ¸ ì—”ì§„ ì„¤ê³„

> `client/src/features/clients/components/config-form/configTestEngine.js`
>
> ì´ ë¬¸ì„œëŠ” Trigger íŒ¨í„´ ë§¤ì¹­ í…ŒìŠ¤íŠ¸ ì—”ì§„ì˜ í•µì‹¬ ì„¤ê³„ë¥¼ ì •ë¦¬í•©ë‹ˆë‹¤.
> ë¦¬íŒ©í† ë§ ì‹œ ë°˜ë“œì‹œ ì°¸ì¡°í•˜ì—¬ regex/delay step ì²˜ë¦¬ ë¡œì§ì„ ìœ ì§€í•´ì•¼ í•©ë‹ˆë‹¤.

---

## 1. Step íƒ€ì…ë³„ Outcome ëª¨ë¸

### 1.1 regex step

ì¼ë°˜ì ì¸ íŒ¨í„´ ë§¤ì¹­ step. syntax ì¡°ê±´ì´ ë§Œì¡±í•˜ë©´ nextë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤.

| ìƒíƒœ | ì¡°ê±´ | ê²°ê³¼ | UI í‘œì‹œ |
|------|------|------|---------|
| **ë°œë™** (fired) | `times`íšŒ ë§¤ì¹­ + `duration` ì´ë‚´ | next step ë˜ëŠ” terminal action ì§„í–‰ | ì´ˆë¡ "â†’ ë°œë™ âœ…" |
| **ë¯¸ë°œë™** (pending) | ë§¤ì¹­ ë¶€ì¡± ë˜ëŠ” duration ì´ˆê³¼ | ì²´ì¸ ë¯¸ì™„ë£Œ (ëŒ€ê¸°) | ë…¸ë€ "â†’ ë¯¸ë°œë™ â³" |

- `fired = true` â†’ ì²´ì¸ ì§„í–‰
- `fired = false` â†’ ì²´ì¸ ì¤‘ë‹¨

### 1.2 delay step

ì§€ì—°/ì·¨ì†Œ step. syntax ì¡°ê±´ì´ ë§Œì¡±í•˜ë©´ ì²´ì¸ì„ **ë¦¬ì…‹**(ì·¨ì†Œ)í•©ë‹ˆë‹¤.
timeout ì‹œ nextë¥¼ ì‹¤í–‰í•˜ëŠ” **ì§€ì—° ì‹¤í–‰** ìš©ë„ì…ë‹ˆë‹¤.

| ìƒíƒœ | ì¡°ê±´ | ê²°ê³¼ | UI í‘œì‹œ |
|------|------|------|---------|
| **ì·¨ì†Œ** (cancelled) | `duration` ì´ë‚´ì— `times`íšŒ ë§¤ì¹­ | ì²´ì¸ ë¦¬ì…‹ (step 0ìœ¼ë¡œ ë³µê·€) | ì£¼í™© "â†’ ì·¨ì†Œ ğŸ”„" |
| **íƒ€ì„ì•„ì›ƒ** (timedOut) | duration ì´ˆê³¼ ë˜ëŠ” ë¡œê·¸ ëê¹Œì§€ ë¯¸ë§¤ì¹­ | next step ë˜ëŠ” terminal action ì§„í–‰ (**ì´ê²ƒì´ ì‹¤ì œ ë°œë™**) | íŒŒë‘ "â†’ íƒ€ì„ì•„ì›ƒ â±ï¸" |

- `fired = true, cancelled = true` â†’ íŒ¨í„´ ë§¤ì¹­ë¨ = ì²´ì¸ ë¦¬ì…‹ (ë°œë™ ì•„ë‹˜)
- `fired = false, timedOut = true` â†’ íƒ€ì„ì•„ì›ƒ = ì²´ì¸ ì§„í–‰ (ì‹¤ì œ ë°œë™)

> **í•µì‹¬**: delayì˜ ì˜ë¯¸ê°€ regexì™€ **ë°˜ëŒ€**ì…ë‹ˆë‹¤.
> - regex: ë§¤ì¹­ = ë°œë™, ë¯¸ë§¤ì¹­ = ë¯¸ì™„ë£Œ
> - delay: ë§¤ì¹­ = ì·¨ì†Œ(ë¦¬ì…‹), íƒ€ì„ì•„ì›ƒ = ë°œë™(ì§„í–‰)

---

## 2. Duration ì²˜ë¦¬

### 2.1 regex stepì˜ duration

- **ê¸°ì¤€ ì‹œì **: ì´ì „ stepì˜ ë§ˆì§€ë§‰ ë§¤ì¹­ íƒ€ì„ìŠ¤íƒ¬í”„ (`prevStepLastTimestamp`)
  - ì²« ë²ˆì§¸ stepì´ë©´ ìì²´ ë§¤ì¹­ ê°„ ì‹œê°„ ì°¨ (sliding window)
- **íŒì •**: `lastMatchTimestamp - refTimestamp <= durationMs` â†’ ë°œë™
- **ì´ˆê³¼ ì‹œ**: sliding window (earliest match ì œê±° í›„ ê³„ì† ìŠ¤ìº”)

### 2.2 delay stepì˜ duration

- **ê¸°ì¤€ ì‹œì **: ì´ì „ stepì˜ ë§ˆì§€ë§‰ ë§¤ì¹­ íƒ€ì„ìŠ¤íƒ¬í”„ (`prevStepLastTimestamp`)
- **íƒ€ì„ì•„ì›ƒ íŒì •**: í˜„ì¬ ë¼ì¸ íƒ€ì„ìŠ¤íƒ¬í”„ > `prevStepLastTimestamp + durationMs`
  - â†’ ì¦‰ì‹œ ìŠ¤ìº” ì¤‘ë‹¨, íƒ€ì„ì•„ì›ƒ ì²˜ë¦¬ (í•´ë‹¹ ë¼ì¸ì€ ì†Œë¹„í•˜ì§€ ì•ŠìŒ)
- **ì·¨ì†Œ íŒì •**: duration ì´ë‚´ì— íŒ¨í„´ ë§¤ì¹­ â†’ `fired=true, cancelled=true`
- **ë¡œê·¸ ë ë„ë‹¬**: ë‚¨ì€ ë¡œê·¸ ì—†ì´ duration ë‚´ ë§¤ì¹­ ì—†ìŒ â†’ íƒ€ì„ì•„ì›ƒ

---

## 3. ì²´ì¸ ì™„ë£Œ ì¡°ê±´ (allFired)

ì²´ì¸ì´ "ì™„ë£Œ"ë˜ë ¤ë©´ ë§ˆì§€ë§‰ stepê¹Œì§€ ë„ë‹¬í•´ì•¼ í•©ë‹ˆë‹¤:

| ë§ˆì§€ë§‰ step íƒ€ì… | ì™„ë£Œ ì¡°ê±´ |
|-----------------|----------|
| regex | `fired = true` (íŒ¨í„´ ë§¤ì¹­ë¨) |
| delay | `fired = false, timedOut = true` (íƒ€ì„ì•„ì›ƒ â†’ next ì§„í–‰) |

ì²´ì¸ ë¦¬ì…‹(delay ì·¨ì†Œ)ì€ ì™„ë£Œê°€ **ì•„ë‹™ë‹ˆë‹¤**.

---

## 4. ë°œë™ íƒ€ì„ìŠ¤íƒ¬í”„ (firingTimestamp)

Limitation ìœˆë„ìš° ê³„ì‚°ì— ì‚¬ìš©ë˜ëŠ” íƒ€ì„ìŠ¤íƒ¬í”„:

| ì‹œë‚˜ë¦¬ì˜¤ | íƒ€ì„ìŠ¤íƒ¬í”„ |
|---------|-----------|
| ë§ˆì§€ë§‰ stepì´ regex ë°œë™ | ë§ˆì§€ë§‰ ë§¤ì¹­ ë¼ì¸ì˜ íƒ€ì„ìŠ¤íƒ¬í”„ |
| ë§ˆì§€ë§‰ stepì´ delay íƒ€ì„ì•„ì›ƒ | `ì´ì „ step íƒ€ì„ìŠ¤íƒ¬í”„ + delay.duration` (íƒ€ì„ì•„ì›ƒ ë°œìƒ ì‹œì ) |

---

## 5. ë°œë™ ì œí•œ (Limitation)

```json
"limitation": {
  "times": 1,
  "duration": "1 minutes"
}
```

- **ëŒ€ìƒ**: ì²´ì¸ ì™„ë£Œ(= ìµœì¢… action ì‹¤í–‰) íšŸìˆ˜
- **ìœˆë„ìš°**: `limitation.duration` ê¸°ê°„ ë‚´
- **ì œí•œ**: ìœˆë„ìš° ë‚´ ìµœëŒ€ `limitation.times`íšŒë§Œ ë°œë™ í—ˆìš©
- **ì´ˆê³¼ ì‹œ**: ì–µì œ (suppressed) â€” ì²´ì¸ì€ ë§¤ì¹­ë˜ì—ˆìœ¼ë‚˜ action ì‹¤í–‰í•˜ì§€ ì•ŠìŒ

### 5.1 ë°˜ë³µ ì²´ì¸ ì‹¤í–‰

Limitationì´ ì„¤ì •ë˜ë©´ ë¡œê·¸ ì „ì²´ë¥¼ ëŒ€ìƒìœ¼ë¡œ ì²´ì¸ì„ ë°˜ë³µ ì‹¤í–‰í•©ë‹ˆë‹¤:

1. `executeOneChain()`ìœ¼ë¡œ ì²« ì²´ì¸ ì‹¤í–‰
2. ì™„ë£Œ ì‹œ â†’ firingTimestamp ê¸°ë¡, limitation ìœˆë„ìš° ì²´í¬
3. ë‚¨ì€ ë¡œê·¸ì—ì„œ ë‹¤ì‹œ ì²´ì¸ ì‹¤í–‰ (lineOffset ì´ë™)
4. ë¯¸ì™„ë£Œ ì‹œ â†’ ì¤‘ë‹¨

### 5.2 ì§‘ê³„ ìš©ì–´

| ìš©ì–´ | ì˜ë¯¸ |
|------|------|
| **ê°ì§€** (totalFirings) | ì²´ì¸ ë§¤ì¹­ ì™„ë£Œ íšŸìˆ˜ (ì–µì œ í¬í•¨) |
| **ë°œë™** (allowedFirings) | ì‹¤ì œ action ì‹¤í–‰ íšŸìˆ˜ |
| **ì–µì œ** (suppressedFirings) | limitationì— ì˜í•´ ì°¨ë‹¨ëœ íšŸìˆ˜ |

---

## 6. Step Result í•„ë“œ ì •ë¦¬

```javascript
{
  name: 'Step_1',           // step ì´ë¦„
  type: 'regex' | 'delay',  // step íƒ€ì…
  patterns: [...],           // trigger syntax ëª©ë¡
  required: {
    times: 2,                // í•„ìš” ë§¤ì¹­ íšŸìˆ˜
    duration: '1 minutes'    // duration ë¬¸ìì—´
  },
  fired: Boolean,            // íŒ¨í„´ ë§¤ì¹­ ì™„ë£Œ ì—¬ë¶€
  cancelled: Boolean,        // delay ì „ìš©: ì·¨ì†Œ(ë¦¬ì…‹) ì—¬ë¶€ (fired && delay)
  timedOut: Boolean,         // delay ì „ìš©: íƒ€ì„ì•„ì›ƒ ì—¬ë¶€ (!fired && delay)
  matchCount: Number,        // ì‹¤ì œ ë§¤ì¹­ëœ íšŸìˆ˜
  matches: [...],            // ë§¤ì¹­ëœ ë¼ì¸ ì •ë³´
  nextAction: String,        // UI í‘œì‹œìš© ë‹¤ìŒ ì•¡ì…˜ ë¼ë²¨
  durationCheck: {           // duration ê²€ì¦ ê²°ê³¼
    elapsed: String,         // ê²½ê³¼ ì‹œê°„ (í•œêµ­ì–´)
    limit: String,           // ì œí•œ ì‹œê°„ (í•œêµ­ì–´)
    passed: Boolean,         // í†µê³¼ ì—¬ë¶€
    message: String          // ì¶”ê°€ ì„¤ëª…
  },
  resetChain: Boolean        // delay ì·¨ì†Œ ì‹œ ì²´ì¸ ë¦¬ì…‹ í”Œë˜ê·¸
}
```

---

## 7. UI ìƒ‰ìƒ ì²´ê³„

| ìƒíƒœ | ë°°ê²½ìƒ‰ | í…ìŠ¤íŠ¸ìƒ‰ | ì•„ì´ì½˜ |
|------|--------|---------|-------|
| ë°œë™ (regex fired) | green-50 | green-600 | âœ… |
| ì·¨ì†Œ (delay cancelled) | orange-50 | orange-600 | ğŸ”„ |
| íƒ€ì„ì•„ì›ƒ (delay timedOut) | blue-50 | blue-600 | â±ï¸ |
| ë¯¸ë°œë™ (pending) | gray-50 | yellow-600 | â³ |
